:source-highlighter: rouge
:table-caption: Tabel
:figure-caption: Joonis
:imagesdir: images
:pdf-style: cyber-theme.yml
:icons: font
:classification: AVALIK
:title-page-background-image: {pdf-stylesdir}/images/title_page_bg_Avalik.svg
:title-page:
:toclevels: 3
:toc-title: Sisukord
:version-label: Versioon
:numbered:
:docnumber:
:author: Tehniline dokument
:revdate: 27.04.2022
:revnumber: 1.0
:numbered:
:docnumber: D-X-XXX
:author: D-X-XXX

= CDOC 2.0 võtmeedastusserveri arhitektuur

== Sissejuhatus

See dokument kirjeldab CDOC 2.0 võtmeedastusserveri arhitektuuri ja kasutatavaid tehnoloogiaid.

CDOC 2.0 on failide salastamiseks mõeldud andmevorming. CDOC 2.0 konteinereid võib edastada üle avalike sidekanalite. Täiendava tulevikuturvalisuse saavutamiseks näeb CDOC 2.0 ette võimaluse eraldada failide dekrüpteerimiseks vajalik võtmekapsel üle avaliku võrgu liikuvast konteinerist ning edastada see vastuvõtjatele kasutades täiendavalt turvatud sidekanaleid.

Võtmeedastusserver on CDOC 2.0 süsteemi komponent, mis loob võtmekapsli edastamiseks vajaliku täiendavalt turvatud sidekanali saatja ja vastuvõtja vahel.

Võtmeedastusserver pakub saatjale teenust võtmeedastuskapsli üleslaadimiseks ning vastuvõtjale teenust võtmeedastuskapsli allalaadimiseks.

Mõlemad teenused kasutavad HTTPS protokolli. Saatjale mõeldud teenus ei autendi saatjat -- seda saavad kasutada kõik. Vastuvõtjale mõeldud teenus autendib vastuvõtjat TLS kliendi autentimise abil -- seda saavad kasutada vaid toetatud eID vahendit (näiteks ID-kaart) omavad kasutajad.

Võtmeedastusserver talletab töökindlalt saatjate poolt edastatud võtmekapslid oma andmebaasis. Võtmeedastusserver kustutab võtmekapslid määratud aja möödumisel, et vähendada võtmeserveri võimalikul kompromiteerumisel tekkivat kahju.

[[sample]]
.Näidis
image::sample.png[]

== Võtmeedastusserveri arhitektuur

[plantuml, target=diagram-classes, format=svg]
.CDoc 2.0 võtmeedastus serveri komponendid
....
@startuml
'https://plantuml.com/component-diagram

interface "mTLS with eID certificate\nGET /ecc-details/{id}" as mtls #black
interface "TLS\n POST /ecc-details" as tls

frame "RIA" {
[cdoc20-server] as server
[TLS / LoadBalancer] as broker
broker --> server: POST /ecc-details
broker --> server: GET /ecc-details/{id}\n+eID certificate

interface "heartbeat\n(monitoring)" as hr #grey
hr -right- server
mtls -- broker
tls -- broker

server -down-> db

database "PostgreSQL" as db {
}
}
@enduml
....



== Kasutatavad tehnoloogiad
* Maven 3.8.x
* Java 17
* Spring Boot 2.0
* https://google.github.io/flatbuffers/[FlatBuffers]
* OpenAPI generator (https://openapi-generator.tech/docs/generators/java[client], https://openapi-generator.tech/docs/generators/spring[spring])
* https://www.bouncycastle.org/[Bouncy Castle Crypto]
* https://commons.apache.org/proper/commons-compress/[Apache Commons Compress]
* PostgreSQL
* https://picocli.info/[picocli]
* slf4j
